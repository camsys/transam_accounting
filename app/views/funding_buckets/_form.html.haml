= simple_form_for(@bucket_proxy,
:url => funding_buckets_path,
:method => :post,
:html => {:class => 'form-vertical bucket_form' },
:wrapper => :vertical_form,
:wrapper_mappings => {:check_boxes => :vertical_radio_and_checkboxes, :radio_buttons => :vertical_radio_and_checkboxes, :file => :vertical_file_input, :boolean => :vertical_boolean}) do |f|

  =f.hidden_field :return_to_bucket_index, :id => 'return_to_bucket_index'
  .row
    .col-sm-8
      = f.input :program_id, :required => true, :collection => FundingSource.all, :include_blank => true, :label => "Program", :selected => params[:funding_source_id]

  .template_id_div{:id => "template_id_div_id"}
    .row
      .col-sm-8
        = f.input :template_id, :required => true, :collection => @templates, :include_blank => true, :label => "Template", :selected => params[:template_id]
  .owner_id_div{:id => "owner_id_div_id"}
    .row
      .col-sm-8
        = f.input :owner_id, :required => true, :collection => @template_organizations, :include_blank => true, :label => "Owner", :selected => params[:owner_id]

  .fiscal_year_div{:id => "fiscal_year_div"}
    .row
      .col-sm-4
        = f.input :fiscal_year_range_start, :required => true, :collection => @fiscal_years, :include_blank => true, :label => "From FY", :selected => params[:fiscal_year_range_start]
      .col-sm-4
        = f.input :fiscal_year_range_end, :required => true, :collection => @fiscal_years, :include_blank => true, :label => "To FY", :selected => params[:fiscal_year_range_end]

  .escalate_by_div{:id => "escalate_by_div_id"}
    .row
      .col-sm-8
        = f.input :inflation_percentage, :wrapper => :vertical_append,:label => 'Escalate By' do
          = f.input_field :inflation_percentage, :class => 'form-control', :max => 100, :step => 0.001
          %span.input-group-addon
            %i.fa.fa-percent
  .state_or_single_agency_budget{:id => "state_or_single_agency_budget_id"}
    .row
      .col-sm-12
        %span.default_funding_bucket_name{:id => "default_funding_bucket_name"}
        %span.custom_funding_bucket_name{:id => "custom_funding_bucket_name"}
          =f.input :name, :as => :text, :label=> 'Bucket Name', :required => true
      .col-sm-8
        = f.input :total_amount, :as => :integer, :label => 'Budget ($)', :required => true, :input_html => { :min => 1  }

  .all_agencies_covered_by_template_group{:id => "all_agencies_covered_by_template_group_id"}
    .all_agencies_covered_by_template{:id => "all_agencies_covered_by_template_id"}

  .modal.fade#form-modal{:tabindex => -1, :role => 'dialog', :aria => {:hidden => true}}

  .row
    .col-sm-6
      =button_tag 'Submit', :onclick=>"before_submit_bucket_check(true); return false;", :class =>  'btn btn-primary'

    .col-sm-6{:id => 'do_not_return_to_buckets_index_after_create'}
      =button_tag 'Submit and Add Another', :onclick=>"before_submit_bucket_check(false); return false;", :class =>  'btn btn-primary'

-#= render 'form_scripts'

:javascript

  var display_budget = false;
  var display_all_orgs_budget = false;
  var display_escalate_by = false;
  var display_fiscal_years = false;
  var multiple_years = false;
  var multiple_agencies = false;
  var multiple_buckets_for_agency_year = false;


  // if defaults set
  $(document).ready(function() {
    $('#funding_bucket_proxy_program_id').change();
  });

  if($('#funding_bucket_proxy_template_id').val() == null || $('#funding_bucket_proxy_template_id').val() == '')
  {
    $('#template_id_div_id').hide();
  }
  if($('#funding_bucket_proxy_owner_id').val() == null || $('#funding_bucket_proxy_owner_id').val() == '')
  {
    $('#owner_id_div_id').hide();
  }else
  {
    console.log('$(#funding_bucket_proxy_owner_id).val()==____'+$('#funding_bucket_proxy_owner_id').val()+'____');
  }

  if($('#funding_bucket_proxy_fiscal_year_range_start').val() == '' || $('#funding_bucket_proxy_fiscal_year_range_end').val() == '')
  {
    $('#fiscal_year_div').hide();
    $('#escalate_by_div_id').hide();
  }else{
    show_escalate_by($("#funding_bucket_proxy_fiscal_year_range_start").val(), $("#funding_bucket_proxy_fiscal_year_range_end").val());
  }

  if($("#funding_bucket_proxy_total_amount").val() == '')
  {
    $("#state_or_single_agency_budget_id").hide();
  }
  $("#all_agencies_covered_by_template_group_id").hide();

  if($("#funding_bucket_proxy_name").val() == '')
  {
    $("#custom_funding_bucket_name").hide();
    $("#do_not_return_to_buckets_index_after_create").hide();
  }


  $('#form-modal').on('hidden.bs.modal', function (e) {
    $('#form-modal input').prop('checked', false);
  });

  $('.bucket_form').validate({
    debug: true
  });

  $( "#funding_bucket_proxy_fiscal_year_range_start" ).rules( "add", {
    FYRange: true
  });

  $( "#funding_bucket_proxy_fiscal_year_range_end" ).rules( "add", {
    FYRange: true
  });

  $( "#funding_bucket_proxy_inflation_percentage" ).rules( "add", {
    PercentThreeDigits: true
  });

  $.validator.addClassRules("agency_budget", {
    require_from_group: [1, ".agency_budget"],
    integer: true,
    min: 1
  });

  $.extend($.validator.messages, {
    integer: 'Please enter a whole number greater than or equal to 1.',
    min: 'Please enter a whole number greater than or equal to 1.'
  });

  $.validator.addMethod("FYRange", function(value, element) {
    if (($('#funding_bucket_proxy_fiscal_year_range_start').val() != "") && ($('#funding_bucket_proxy_fiscal_year_range_end').val() != "")) {
      return (parseInt($('#funding_bucket_proxy_fiscal_year_range_start').val()) <= parseInt($('#funding_bucket_proxy_fiscal_year_range_end').val()));
    } else {
      return true;
    }
  }, "Not a valid year range.");

  $.validator.addMethod('PercentThreeDigits', function(value, element) {
     return this.optional(element) || /^\d*(\.\d{0,3})?$/.test(value);
  }, "Please enter a correct percent up to three decimal places.");

  var agencies = []

  function remove_all_agencies_fields(){
    $("div.row_agencies").remove();
  }

  function populate_all_agencies_fields(){
    //Always best to be sure that this isn't double populating agencies
    remove_all_agencies_fields();

    //There should be an entry before the first agency. the empty space and the all agencies option
    i = 0;

    while(i < agencies.length)
    {
        var add_to = "#all_agencies_covered_by_template_id"
        var id = agencies[i][0];
        var name = agencies[i][1];

        var program = $('#funding_bucket_proxy_program_id option:selected').text();
        var template = $('#funding_bucket_proxy_template_id option:selected').text();
        var bucket_name =program+'-'+template+'-'+name+'-FYXX/ZZ';

        var new_input =
          '<div class="row_agencies"><div class="col-sm-12">' +
          '<div><span class="control-label" id="row_agencies_name' + id + '" name="row_agencies_name' + name + '" type="text">'+bucket_name+'</div>' +
          '<div class="form-group"><label class="control-label" id="agency_label_' + id + '" name="agency_label_' + name + '" type="text">'+name+' Budget ($)</label>' +
          '<div><input autocomplete="off" class="input form-control agency_budget" id="' + id + '" name="agency_budget_id_' + id + '" label="' + id + '" type="text"></div>' +
          '</div></div></div>';
        $(add_to).before(new_input);
        $("#field" + id).attr('data-source',$(add_to).attr('data-source'));
      i++;
    }
  }

  $('#funding_bucket_proxy_owner_id').change(function(){
    if ($('#funding_bucket_proxy_owner_id').val() == -1){
      $("#state_or_single_agency_budget_id").hide();
      funding_bucket_proxy_total_amount.value = null;
      $("#all_agencies_covered_by_template_group_id").show();
      display_budget = false;
      display_all_orgs_budget = true;
      populate_all_agencies_fields();
    }
    else{
      //We don't need all the agencies fields so remove them
      remove_all_agencies_fields();
      $("#state_or_single_agency_budget_id").show();
      display_budget = true;
      display_all_orgs_budget = false;
      $("#all_agencies_covered_by_template_group_id").hide();
      $('#all_agencies_covered_by_template_id').empty();
    }
  })

  function show_escalate_by(start_fy, end_fy){
    if(start_fy === end_fy && start_fy > 0)
    {
      $("#escalate_by_div_id").hide();
      funding_bucket_proxy_inflation_percentage.value = null;
      display_escalate_by = false;
      if(multiple_buckets_for_agency_year)
      {
        $('#custom_funding_bucket_name').show();
        $('#do_not_return_to_buckets_index_after_create').show();
        $('#default_funding_bucket_name').hide();
      }else
      {
        $('#custom_funding_bucket_name').hide();
        $('#default_funding_bucket_name').show();
        $('#do_not_return_to_buckets_index_after_create').hide();
      }

    }
    else {
      $("#escalate_by_div_id").show();
      $('#custom_funding_bucket_name').hide();
      $('#do_not_return_to_buckets_index_after_create').hide();
      $('#default_funding_bucket_name').show();
      update_expected_escalation_percent();
      display_escalate_by = false;
    }

    update_bucket_name();
  };

  $('#funding_bucket_proxy_fiscal_year_range_start').change(function(){
    if(!multiple_years)
    {
      $('#funding_bucket_proxy_fiscal_year_range_end').val($('#funding_bucket_proxy_fiscal_year_range_start').val());
    }
    show_escalate_by(funding_bucket_proxy_fiscal_year_range_start.value, funding_bucket_proxy_fiscal_year_range_end.value);

  });
  $('#funding_bucket_proxy_fiscal_year_range_end').change(function(){
    if(!multiple_years)
    {
      $('#funding_bucket_proxy_fiscal_year_range_start').val($('#funding_bucket_proxy_fiscal_year_range_end').val());
    }
    show_escalate_by(funding_bucket_proxy_fiscal_year_range_start.value, funding_bucket_proxy_fiscal_year_range_end.value);
  });
  $('#funding_bucket_proxy_owner_id').change(function(){
    update_bucket_name();
    $('#fiscal_year_div').show();
  });

  function build_bucket_name(){
    var program = $('#funding_bucket_proxy_program_id option:selected').text();
    var template = $('#funding_bucket_proxy_template_id option:selected').text();
    var owner = $('#funding_bucket_proxy_owner_id option:selected').text();
    var fy = 'FYXX/ZZ';

    var start_year = $('#funding_bucket_proxy_fiscal_year_range_start option:selected').text();
    var end_year = $('#funding_bucket_proxy_fiscal_year_range_end option:selected').text();

    if(start_year == end_year)
    {
      fy = start_year;
      fy = fy.replace(" ", "");
      fy = fy.replace("-", "/");
    }

    return program+'-'+template+'-'+owner+'-'+fy;
  }

  function update_bucket_name(){
    bucket_name = build_bucket_name();

    $('#default_funding_bucket_name').text(bucket_name);
    $('#funding_bucket_proxy_name').text(bucket_name+'-');
  }

  function set_bucket_configuration_from_template(template_id){
    var url = '#{find_configuration_options_from_template_id_funding_buckets_path}';
    $.ajax({
      url: url,
      data: {template_id: template_id},
      success: function(result){
        multiple_years = result.recurring;
        multiple_agencies = result.create_multiple_agencies;
        multiple_buckets_for_agency_year = result.create_multiple_buckets_for_agency_year;
      },
      error: function (xhr, ajaxOptions, thrownError) {
        alert("We are sorry but something went wrong. " + xhr.status + " " + thrownError);
        }
      });
  }

  function before_submit_bucket_check(return_to_bucket_index){

    if(return_to_bucket_index != null)
    {
      $('#return_to_bucket_index').val(return_to_bucket_index);
    }


    if ($('.bucket_form').valid())
    {
      var url = '#{find_existing_buckets_for_create_funding_buckets_path}';
      var template_id = $('#funding_bucket_proxy_template_id').val();
      var start_year = funding_bucket_proxy_fiscal_year_range_start.value;
      var end_year = funding_bucket_proxy_fiscal_year_range_end.value;
      var owner_id = $('#funding_bucket_proxy_owner_id').val();
      var name = $('#funding_bucket_proxy_name').val();
      var specific_organizations_with_budgets = [];

      var i = 0;
      while(i<funding_bucket_proxy_owner_id.options.length){
        var val = funding_bucket_proxy_owner_id.options[i].value;
        var input_name = 'agency_budget_id_'+val
        var input_value = $('input:text[name='+input_name+']').val();

        if (input_value>0)
        {
          specific_organizations_with_budgets.push(val);
        }

        i++;
      }

      $.ajax({
        url: url,
        data: {
          template_id: template_id,
          start_year: start_year,
          end_year: end_year,
          owner_id: owner_id,
          name: name,
          specific_organizations_with_budgets: specific_organizations_with_budgets},
        success: function(result){
          if (result.result_count == 0 || $('#funding_bucket_proxy_create_conflict_option_replace').is(':checked')|| $('#funding_bucket_proxy_create_conflict_option_ignore').is(':checked') || $('#funding_bucket_proxy_create_conflict_option_cancel').is(':checked')) {
            document.getElementById('new_funding_bucket_proxy').submit();
          }else{
            $('.bucket_form').valid();

            $('#form-modal').html(result.new_html);
            $('#form-modal').modal('show');
          };
        },
        error: function (xhr, ajaxOptions, thrownError) {
          alert("We are sorry but something went wrong. " + xhr.status + " " + thrownError);
          }
      });
    }
  }

  function update_fiscal_year_range()
  {
    $('#funding_bucket_proxy_fiscal_year_range_start').empty();
    $('#funding_bucket_proxy_fiscal_year_range_end').empty();
    var url = '#{find_template_based_fiscal_year_range_funding_buckets_path}';
    if ( $('#funding_bucket_proxy_program_id').val() > 0)
    {
      $.ajax({
        url: url,
        data: {program_id: $('#funding_bucket_proxy_program_id').val()},
        success: function(result){
          //Add a blank entry to the list.
          $("#funding_bucket_proxy_fiscal_year_range_start").append( $("<option></option>").attr("value", "").text(''));
          $("#funding_bucket_proxy_fiscal_year_range_end").append( $("<option></option>").attr("value", "").text(''));
          for(i = 0;i<result.length;i++){
            //add an option for each organizations available to the tempalte
            $("#funding_bucket_proxy_fiscal_year_range_start").append(
                $("<option></option>").attr("value", result[i][1]).text(result[i][0])
            );
            $("#funding_bucket_proxy_fiscal_year_range_end").append(
                $("<option></option>").attr("value", result[i][1]).text(result[i][0])
            );
          }
        },
        error: function (xhr, ajaxOptions, thrownError) {
          alert("We are sorry but something went wrong. " + xhr.status + " " + thrownError);
          }
        });
    }
  }

  function update_expected_escalation_percent()
  {
    if (funding_bucket_proxy_program_id.value > 0)
    {
      var url = '#{find_expected_escalation_percent_funding_buckets_path}';
      $.ajax({
        url: url,
        data: {program_id: funding_bucket_proxy_program_id.value},
        success: function(result){
          funding_bucket_proxy_inflation_percentage.value = result;
        },
        error: function (xhr, ajaxOptions, thrownError) {
          alert("We are sorry but something went wrong. " + xhr.status + " " + thrownError);
          }
        });
    }else{
      funding_bucket_proxy_inflation_percentage.value = 0;
    }
  }

  $('#funding_bucket_proxy_template_id').change(function(){
    remove_all_agencies_fields();

    if ($('#funding_bucket_proxy_template_id').val() > 0)
    {
      set_bucket_configuration_from_template($('#funding_bucket_proxy_template_id').val());
      update_fiscal_year_range();

      var url = '#{find_organizations_from_template_id_funding_buckets_path}';
      $.ajax({
        url: url,
        data: {template_id: $('#funding_bucket_proxy_template_id').val()},
        success: function(result){
          agencies = result
          $('#funding_bucket_proxy_owner_id').empty();
          $('#owner_id_div_id').show();
          //Add a blank entry to the list.
          $("#funding_bucket_proxy_owner_id").append( $("<option></option>").attr("value", "").text(''));
          // Add an All Agencies
          if (multiple_agencies)
          {
            $("#funding_bucket_proxy_owner_id").append( $("<option></option>").attr("value", "-1").text('All Agencies For This Template'));
          }
          for(i = 0;i<result.length;i++){
            //add an option for each organizations available to the tempalte
            $("#funding_bucket_proxy_owner_id").append(
                $("<option></option>").attr("value", result[i][0]).text(result[i][1])
            );
          }
        },
        error: function (xhr, ajaxOptions, thrownError) {
          alert("We are sorry but something went wrong. " + xhr.status + " " + thrownError);
          }
        });
    }else{
      $('#funding_bucket_proxy_owner_id').empty();
      $('#owner_id_div_id').hide();
    }
  });

  $('#funding_bucket_proxy_program_id').change(function(){
    remove_all_agencies_fields();
    $("#escalate_by_div_id").hide();
    if ($('#funding_bucket_proxy_program_id').val() > 0)
    {
      var url = '#{find_templates_from_program_id_funding_buckets_path}';
      $.ajax({
        url: url,
        data: {program_id: $('#funding_bucket_proxy_program_id').val()},
        success: function(result){
          $('#template_id_div_id').show();
          $('#funding_bucket_proxy_template_id').empty();
          $('#funding_bucket_proxy_owner_id').empty();
          //Add a blank entry to the list
          $("#funding_bucket_proxy_template_id").append( $("<option></option>").attr("value", "").text(''));
          for(i = 0;i<result.length;i++){
            //add in option for each template available to the program
            if (parseInt('#{params[:funding_template_id]}') == result[i][0]) {
              $("#funding_bucket_proxy_template_id").append(
                $("<option></option>").attr("value", result[i][0]).attr("selected", 'selected').text(result[i][1])
              );
            } else {
              $("#funding_bucket_proxy_template_id").append(
                $("<option></option>").attr("value", result[i][0]).text(result[i][1])
              );
            }

            if (parseInt('#{params[:funding_template_id]}') > 0) {
              $('#funding_bucket_proxy_template_id').change();
            }

          }
          $("#state_or_single_agency_budget_id").hide();
          $("#escalate_by_div_id").hide();
          $('#owner_id_div_id').hide();
          $('#fiscal_year_div').hide();
        },
        error: function (xhr, ajaxOptions, thrownError) {
          alert("We are sorry but something went wrong. " + xhr.status + " " + thrownError);
          }
        });
    }else{
      $('#template_id_div_id').hide();
      $('#funding_bucket_proxy_template_id').empty();
      $('#funding_bucket_proxy_owner_id').empty();
    }

  });